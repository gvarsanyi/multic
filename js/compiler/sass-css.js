// Generated by CoffeeScript 1.9.1
var CompilationError, compiler, path;

CompilationError = require('../error/compilation-error');

compiler = require('node-sass');

path = require('path');

module.exports = function(inf, cb) {
  var err, opts, pathes, stats;
  try {
    stats = {};
    pathes = [];
    opts = {
      data: inf.source,
      includePaths: pathes,
      stats: stats,
      error: function(err) {
        var pos;
        pos = CompilationError.parsePos(err.line, err.column, -1, -1);
        inf.res.errors.push(new CompilationError(inf, err, pos));
        return cb();
      },
      success: function(res) {
        var includes, ref, ref1, ref2;
        if ((ref = (includes = res != null ? (ref1 = res.stats) != null ? ref1.includedFiles : void 0 : void 0)) != null ? ref.length : void 0) {
          (ref2 = inf.res.includes).push.apply(ref2, includes);
        }
        inf.res.compiled = res.css;
        return cb();
      }
    };
    if (inf.options.file) {
      opts.file = inf.options.file;
      pathes.push(path.resolve(path.dirname(inf.options.file) + '/'));
    }
    return compiler.render(opts);
  } catch (_error) {
    err = _error;
    inf.res.errors.push(new CompilationError(inf, err));
    return cb();
  }
};
